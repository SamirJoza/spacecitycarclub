name: ğŸš€ Deploy Sage Theme to SiteGround

on:
  push:
    branches:
      - production

jobs:
  deploy:
    name: Deploy via SSH to SiteGround
    runs-on: ubuntu-latest

    steps:
      # ---------------------------------------------
      # ğŸ“¥ Step 1: Checkout the code from Git
      # ---------------------------------------------
      - name: ğŸ§¾ Checkout production branch
        uses: actions/checkout@v3

      # ---------------------------------------------
      # ğŸ” Step 2: SSH Setup with Debugging & Validation
      # ---------------------------------------------
      - name: ğŸ” Set up SSH access (with debug logging)
        run: |
          echo "ğŸ“‚ Creating SSH directory..."
          mkdir -p ~/.ssh || { echo "âŒ Failed to create ~/.ssh directory"; exit 1; }

          echo "ğŸ“ Writing SSH private key..."
          echo "${{ secrets.SG_SSH_KEY }}" > ~/.ssh/id_ed25519 || { echo "âŒ Failed to write SSH key"; exit 1; }

          echo "ğŸ”’ Setting correct permissions..."
          chmod 600 ~/.ssh/id_ed25519 || { echo "âŒ Failed to chmod SSH key"; exit 1; }

          echo "ğŸ§  Checking key format (should begin with -----BEGIN)..."
          head -n 1 ~/.ssh/id_ed25519

          echo "ğŸ” Adding SiteGround host to known_hosts..."
          ssh-keyscan -H ${{ secrets.SG_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || echo "âš ï¸ ssh-keyscan failed â€” check SG_HOST"

          echo "âœ… SSH setup complete."
          
          echo "ğŸ“„ Final ~/.ssh contents:"
          ls -al ~/.ssh
          echo "ğŸ” Key preview:"
          head -n 5 ~/.ssh/id_ed25519

      # ---------------------------------------------
      # ğŸš€ Step 3: Deploy the theme folder using rsync
      # - Deploys all of wp-content/themes/
      # - Uses SSH on a custom port from secret SG_PORT
      # - --delete keeps server in sync with Git repo
      # ---------------------------------------------
      - name: ğŸš€ Deploy theme via rsync (custom SSH port)
        run: |
          echo "ğŸ“¦ Starting rsync deployment..."
          rsync -avz -e "ssh -p ${{ secrets.SG_PORT }}" --delete \
            --exclude '.git*' \
            ./wp-content/themes/ \
            ${{ secrets.SG_USER }}@${{ secrets.SG_HOST }}:${{ secrets.SG_TARGET_DIR }} || {
              echo "âŒ Rsync failed. Check SSH connection, permissions, or target path."
              exit 1
          }

          echo "âœ… Deployment completed successfully."
