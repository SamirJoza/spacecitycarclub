name: 🚀 Deploy Sage Theme to SiteGround

on:
  push:
    branches:
      - production

jobs:
  deploy:
    name: Deploy via SSH to SiteGround
    runs-on: ubuntu-latest

    steps:
      # ---------------------------------------------
      # 📥 Step 1: Checkout the code from Git
      # ---------------------------------------------
      - name: 🧾 Checkout production branch
        uses: actions/checkout@v3

      # ---------------------------------------------
      # 🔐 Step 2: SSH Setup with Debugging & Validation
      # ---------------------------------------------
      - name: 🔐 Set up SSH access (with debug logging)
        run: |
          echo "📂 Creating SSH directory..."
          mkdir -p ~/.ssh || { echo "❌ Failed to create ~/.ssh directory"; exit 1; }

          echo "📝 Writing SSH private key..."
          echo "${{ secrets.SG_SSH_KEY }}" > ~/.ssh/id_ed25519 || { echo "❌ Failed to write SSH key"; exit 1; }

          echo "🔒 Setting correct permissions..."
          chmod 600 ~/.ssh/id_ed25519 || { echo "❌ Failed to chmod SSH key"; exit 1; }

          echo "🧠 Checking key format (should begin with -----BEGIN)..."
          head -n 1 ~/.ssh/id_ed25519

          echo "🔍 Adding SiteGround host to known_hosts..."
          ssh-keyscan -H ${{ secrets.SG_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || echo "⚠️ ssh-keyscan failed — check SG_HOST"

          echo "✅ SSH setup complete."
          
          echo "📄 Final ~/.ssh contents:"
          ls -al ~/.ssh
          echo "🔐 Key preview:"
          head -n 5 ~/.ssh/id_ed25519

      # ---------------------------------------------
      # 🚀 Step 3: Deploy the theme folder using rsync
      # - Deploys all of wp-content/themes/
      # - Uses SSH on a custom port from secret SG_PORT
      # - --delete keeps server in sync with Git repo
      # ---------------------------------------------
      - name: 🚀 Deploy theme via rsync (custom SSH port)
        run: |
          echo "📦 Starting rsync deployment..."
          rsync -avz -e "ssh -p ${{ secrets.SG_PORT }}" --delete \
            --exclude '.git*' \
            ./wp-content/themes/ \
            ${{ secrets.SG_USER }}@${{ secrets.SG_HOST }}:${{ secrets.SG_TARGET_DIR }} || {
              echo "❌ Rsync failed. Check SSH connection, permissions, or target path."
              exit 1
          }

          echo "✅ Deployment completed successfully."
